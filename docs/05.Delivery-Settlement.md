# Delivery & Settlement

This document explains how hashrate delivery and payment settlement work in Lumerin Hashprice Futures.

---

## Delivery Lifecycle

```
┌──────────────────────────────────────────────────────────────────────┐
│                     POSITION DELIVERY LIFECYCLE                      │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  PRE-DELIVERY              DELIVERY PERIOD           POST-DELIVERY   │
│  ────────────              ───────────────           ─────────────   │
│                                                                      │
│  ┌─────────────┐          ┌─────────────────┐      ┌─────────────┐   │
│  │ Position    │          │ Hashrate        │      │ Payment     │   │
│  │ Created     │          │ Delivered       │      │ Released    │   │
│  │             │          │                 │      │             │   │
│  │ • Trading   │  ──►     │ • Seller mines  │ ──►  │ • Seller    │   │
│  │ • Offsetting│          │ • Buyer receives│      │   withdraws │   │
│  │ • Margin    │          │ • Payment locked│      │             │   │
│  └─────────────┘          └─────────────────┘      └─────────────┘   │
│                                                                      │
│  │◄─────────────────────►│◄────────────────►│◄───────────────────►│  │
│      Anytime before          7 days             After expiry         │
│      delivery date          (configurable)                           │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Pre-Delivery Phase

### Position Trading

Before delivery begins, positions can be:

- **Exit**: Close by placing an opposite order and capture the pnl
- **Liquidated**: Closed via margin call if undercollateralized

### Destination URL

To receive hashrate, the **buyer** must ensure their mining endpoint is set when placing the order. Otherwise, the position will be settled in cash at the hashprice indexer price at the time of settlement.

---

### Delivery Payment

Before delivery starts, buyers should deposit delivery payment which equals to the total value of the contract. The payment is locked in the contract until delivery completes or validator cancels the delivery.

### Payment Amount

```
Total Payment = Buy Price Per Day × Delivery Duration Days
```

**Example:**

```
Buy Price:  4.10 USDC/day
Duration:   7 days

Payment = 4.10 USDC/day × 7 days = 28.70 USDC per contract
```

---

## During Delivery

### Seller's Obligation

During the delivery period, the seller must:

1. **Point hashrate** to the buyer's `destURL`
2. **Maintain hashrate** at the contracted speed
3. **Deliver for the full duration** (7 days typical)

### Monitoring

Off-chain trusted validator monitor delivery compliance:

- Check hashrate arriving at destination
- Verify speed matches contract specification
- Track delivery duration

---

## Early Closure (Breach)

### When to Use

Either party or the validator can close delivery early if:

- Seller fails to deliver hashrate
- Buyer fails to provide valid endpoint
- Technical issues prevent delivery

### Blame Assignment

| Caller    | Blame                               |
| --------- | ----------------------------------- |
| Seller    | Seller blamed (admits fault)        |
| Buyer     | Buyer blamed (buyer claims breach)  |
| Validator | Validator decides based on evidence |

### Breach Penalty

The blamed party pays a penalty to the other:

```
Breach Penalty = Position Value × Penalty Rate × Remaining Time / Total Time
```

**Formula:**

```solidity
penalty = price × duration × breachRatePerDay × remainingSeconds
          / SECONDS_PER_DAY / 10^18
```

**Example:**

```
Position Value:    700,000 (0.70 USDC)
Penalty Rate:      5% per day (5e16)
Remaining Time:    3 days (of 7)

Penalty = 700,000 × 0.05 × 3 / 7
        = 15,000 (0.015 USDC)
```

### Cash Settlement on Close

When closing early, the remaining position is settled at market price:

1. **Calculate elapsed time** (already delivered)
2. **Pay for delivered portion** (buyer → seller)
3. **Settle remaining at market** (P&L distributed)
4. **Apply breach penalty** (blamed → other party)

---

## Post-Delivery Settlement

### Seller Withdrawal

After delivery period ends, sellers can claim payment:

```solidity
function withdrawDeliveryPayment(uint256 _deliveryDate) external;
```

**Validation:**

```solidity
if (block.timestamp < _deliveryDate + deliveryDurationSeconds()) {
    revert DeliveryNotFinishedYet();
}
```

### Payment Distribution

```
Seller Receives = Sell Price Per Day × Delivery Duration Days
```

If entry prices differ (from position transfers), the contract settles the difference:

```
Position:
  Buyer Entry:  100,000/day
  Seller Entry: 90,000/day

Buyer Paid:    700,000 (100k × 7)
Seller Gets:   630,000 (90k × 7)
Contract:      70,000 (difference)
```

---

## Complete Delivery Flow

### Happy Path

```
┌─────────────────────────────────────────────────────────────────────┐
│                        SUCCESSFUL DELIVERY                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  T-7 days: Position Created                                         │
│  │         Buyer: 0xAlice, Seller: 0xBob                            │
│  │         Price: 4.10 USDC/day, Duration: 7 days                   │
│  │         destURL: stratum+tcp://alice-pool:3333                   │
│  │                                                                   │
│  T-1 day:  Buyer Deposits Payment                                   │
│  │         Alice calls depositDeliveryPayment([positionId])         │
│  │         28.70 USDC locked in contract                             │
│  │                                                                   │
│  T+0:      Delivery Starts                                          │
│  │         Bob points 100 TH/s to alice-pool:3333                     │
│  │                                                                   │
│  T+7 days: Delivery Ends                                            │
│  │         Bob maintained hashrate for 7 days                       │
│  │                                                                   │
│  T+7+:     Seller Withdraws                                         │
│  │         Bob calls withdrawDeliveryPayment(deliveryDate)          │
│  │         Bob receives 0.70 USDC                                   │
│  │                                                                   │
│  ✓ Complete                                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Breach Path

```
┌─────────────────────────────────────────────────────────────────────┐
│                        DELIVERY BREACH                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  T+0:      Delivery Starts                                          │
│  │         Bob should deliver to Alice's pool                       │
│  │                                                                  │
│  T+3 days: Bob stops delivering                                     │
│  │         Validator detects missing hashrate                       │
│  │                                                                  │
│  T+3:      closeDelivery() called                                   │
│  │         Validator calls closeDelivery(positionId, true)          │
│  │         (blame seller)                                           │
│  │                                                                  │
│  Settlement:                                                        │
│  │  1. Bob pays Alice for 3 days: 12.30 USDC                        │
│  │  2. Remaining 4 days settled at market price                     │
│  │  3. Bob pays breach penalty: ~0.02 USDC                          │
│  │                                                                  │
│  Position closed                                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```
