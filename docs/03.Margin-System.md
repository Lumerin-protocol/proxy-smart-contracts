# Margin System

The Lumerin Futures margin system ensures all positions are properly collateralized, protecting both parties from counterparty default risk.

---

## Overview

Margin is collateral deposited into the Futures contract to guarantee position obligations. The system continuously monitors margin levels and automatically liquidates undercollateralized positions.

```
┌────────────────────────────────────────────────────────────────────┐
│                        MARGIN HIERARCHY                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│     Balance                                                        │
│        │                                                           │
│        ▼                                                           │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ Excess Margin (withdrawable)                                  │ │
│  │ ═══════════════════════════════════════════════════════════   │ │
│  │ ▲                                                             │ │
│  │ │ Unrealized Profit                                           │ │
│  │ ├─────────────────────────────────────────────────────────    │ │
│  │ │ Maintenance Margin        ◄── Minimum to avoid liquidation  │ │
│  │ ├─────────────────────────────────────────────────────────    │ │
│  │ │ Unrealized Loss (if any)                                    │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  If Balance < Min Margin → MARGIN CALL                             │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## Margin Types

### 1. Deposited Collateral (Balance)

The actual token balance held in the contract, represented as wrapped tokens (`wToken`):

### 2. Maintenance Margin

The **minimum collateral** required to hold a position without triggering liquidation:

```
Maintenance Margin = Entry Price × Duration × Quantity × Margin Percent
```

**Components:**

| Factor         | Description                                         |
| -------------- | --------------------------------------------------- |
| Entry Price    | The price per day at which the position was entered |
| Duration       | `deliveryDurationDays` (e.g., 7 days)               |
| Quantity       | Number of contracts (absolute value)                |
| Margin Percent | `liquidationMarginPercent` + breach penalty buffer  |

**Example:**

```
Entry Price:           100,000 (0.10 USDC/day)
Duration:              7 days
Quantity:              1 contract
Liquidation Percent:   20%

Maintenance Margin = 100,000 × 7 × 1 × 0.20
                   = 140,000 (0.14 USDC)
```

### 3. Effective Margin (Min Margin)

The **actual margin requirement** after accounting for unrealized P&L:

```
Effective Margin = Maintenance Margin - Unrealized PnL
```

**For Long Positions:**

```
Unrealized PnL = (Market Price - Entry Price) × Duration × Quantity
```

**For Short Positions:**

```
Unrealized PnL = (Entry Price - Market Price) × Duration × Quantity
```

**Impact:**

| Scenario            | Effect on Effective Margin                       |
| ------------------- | ------------------------------------------------ |
| Profitable position | Lower effective margin (easier to maintain)      |
| Losing position     | Higher effective margin (more collateral needed) |

---

---

## Margin Examples

### Example 1: Opening a Long Position

```
Initial Balance:       1,000,000 (1.00 USDC)
Market Price:          100,000 (0.10 USDC/day)
Entry Price:           100,000 (at market)
Duration:              7 days
Margin Percent:        20%

Maintenance Margin = 100,000 × 7 × 1 × 0.20 = 140,000
Unrealized PnL = 0 (just opened)
Min Margin = 140,000

Excess Margin = 1,000,000 - 140,000 = 860,000 ✓
```

### Example 2: Price Moves Against Position

```
Market Price moves to: 120,000 (0.12 USDC/day)
Entry Price:           100,000

For a SHORT position:
Unrealized PnL = (100,000 - 120,000) × 7 = -140,000 (loss)
Maintenance Margin = 140,000
Effective Margin = 140,000 - (-140,000) = 280,000

If Balance = 250,000:
Deficit = 280,000 - 250,000 = 30,000 → MARGIN CALL
```

### Example 3: Price Moves In Favor

```
Market Price moves to: 80,000 (0.08 USDC/day)
Entry Price:           100,000

For a SHORT position:
Unrealized PnL = (100,000 - 80,000) × 7 = 140,000 (profit)
Maintenance Margin = 140,000
Effective Margin = 140,000 - 140,000 = 0

Min Margin can go to 0 for highly profitable positions.
```

---

## Margin Calls

### What Triggers a Margin Call?

A margin call occurs when:

```
Balance < Min Margin
```

The validator monitors all participants and calls `marginCall(address)` when this condition is met.

### Margin Call Process

```
┌──────────────────────────────────────────────────────────────────┐
│                    MARGIN CALL SEQUENCE                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. Validator detects: Balance < Min Margin                      │
│                          │                                       │
│                          ▼                                       │
│  2. Close all ORDERS first                                       │
│     └─► Reclaim margin from each closed order                    │
│     └─► Check if Balance ≥ Min Margin                            │
│                          │                                       │
│         Still undercollateralized?                               │
│                          │                                       │
│                          ▼                                       │
│  3. Force liquidate POSITIONS                                    │
│     └─► Settle unrealized PnL at hashprice indexer price         │
│     └─► Repeat until Balance ≥ Min Margin                        │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## Validator System

### Role of the Validator

The validator is an off-chain service that:

1. **Monitors** all participant margin utilization via subgraph queries
2. **Alerts** users when utilization exceeds warning thresholds
3. **Executes** margin calls for undercollateralized accounts

### Margin Utilization Calculation

```
Utilization = Min Margin / Balance × 100%

< 80%:    Safe
80-100%:  Warning (notifications sent)
≥ 100%:   Margin call executed
```

---

## Best Practices

### For Traders

1. **Monitor Utilization**: Keep utilization below 80% to avoid warnings
2. **Add Buffer**: Deposit more than the minimum required
3. **Set Alerts**: Use the notification service for margin warnings
4. **Act Quickly**: Top up collateral immediately when warned

### For Miners (Sellers)

1. **Account for Volatility**: Hash prices can move significantly
2. **Conservative Sizing**: Don't over-commit production capacity
3. **Delivery Reserves**: Keep extra margin for delivery payment phase

### Utilization Guidelines

| Utilization | Status      | Action                    |
| ----------- | ----------- | ------------------------- |
| 0-50%       | Safe        | Normal operation          |
| 50-80%      | Moderate    | Monitor closely           |
| 80-95%      | Warning     | Consider adding margin    |
| 95-100%     | Critical    | Immediate action required |
| >100%       | Liquidation | Margin call imminent      |

---

## Read next

- [Trading Guide](./04.Trading-Guide.md) - Managing orders and positions
- [Delivery & Settlement](./05.Delivery-Settlement.md) - Delivery payment flow
