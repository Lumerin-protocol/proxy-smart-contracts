stages:
  - test
  - build
  - release-bindings
  - deploy-goerli
  - deploy-mainnet

# Sets ENV_NAME=ENV_VALUE in shell and gitlab ci project ci/cd variables
# TODO: support scoped variables by adding
# --form environment_scope=$CI_ENVIRONMENT_SLUG
# --form filter[environment_scope]=$CI_ENVIRONMENT_SLUG
.set-env: &set-env
  - "declare '$ENV_NAME=$ENV_VALUE' && \
    curl --request PUT --header 'PRIVATE-TOKEN: $GITLAB_TOKEN' \
    '$CI_API_V4_URL/projects/$CI_PROJECT_ID/variables/$ENV_NAME' \
    --form 'value=$ENV_VALUE'"

test:
  stage: test
  image: node:14-buster
  allow_failure: true
  only:
    - branches
  script:
    - cd ./Goerli/clonefactory/ && yarn install && make test
  artifacts:
    paths:
      - Goerli/lumerintoken/node_modules
      - Goerli/clonefactory/node_modules

compile-contracts:
  stage: build
  image: node:14-buster
  needs: ["test"]
  script:
    - cd ./Goerli/clonefactory/ && yarn install && make compile
  artifacts:
    paths:
      - Goerli/clonefactory/abi
      - Goerli/clonefactory/artifacts
      - Goerli/clonefactory/cache
      - Goerli/clonefactory/node_modules

build-contracts-go:
  stage: build
  needs: ["compile-contracts"]
  image: ethereum/client-go:alltools-stable
  script: cd ./Goerli/clonefactory && ./build-go.sh
  artifacts:
    untracked: true
    paths:
      - Goerli/clonefactory/bindings-go

build-contracts-js:
  stage: build
  needs: ["compile-contracts"]
  image: node:14-buster
  script: cd ./Goerli/clonefactory && make build-js
  artifacts:
    untracked: true
    paths:
      - Goerli/clonefactory/bindings-js

deploy-lumerintoken-clonefactory:
  stage: deploy-goerli
  needs: ["compile-contracts"]
  image: node:14-buster
  environment: goerli
  when: manual
  # only:
  #   - main
  script:
    # - cd ./Goerli/clonefactory/ &&
    #   make deploy-lumerin &&
    #   export ENV_NAME="LUMERIN_TOKEN_ADDR" ENV_VALUE=$(cat lumerin-addr.tmp)
    - export ENV_NAME="LUMERIN_TOKEN_ADDR" ENV_VALUE="TEST-VALUE"
    - *set-env
    - make deploy-clonefactory
    - export ENV_NAME=CLONEFACTORY_ADDR ENV_VALUE=$(cat clonefactory-addr.tmp)
    - *set-env
    - make populate-contracts

deploy-clonefactory:
  variables:
    LUMERIN_TOKEN_ADDR: ""
  stage: deploy-goerli
  needs: ["compile-contracts"]
  image: node:14-buster
  environment: goerli
  when: manual
  # only:
  #   - main
  script:
    - cd ./Goerli/clonefactory/
    - make deploy-clonefactory
    - export ENV_NAME="CLONEFACTORY_ADDR" ENV_VALUE=$(cat clonefactory-addr.tmp)
    - *set-env
    - make populate-contracts

release-contracts-go:
  stage: release-bindings
  needs: ["build-contracts-go"]
  image: node:14-buster
  when: manual
  # only:
  #   - main
  before_script:
    - apt-get -yq update && apt-get -yqq install openssh-client
    - mkdir ~/.ssh
    - ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
  script:
    - cp $SSH_KEY_CONTRACTS_GO ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - cd ./Goerli/clonefactory/ && make release-go

release-contracts-js:
  stage: release-bindings
  needs: ["build-contracts-js"]
  image: node:14-buster
  when: manual
  # only:
  #   - main
  before_script:
    - apt-get -yq update && apt-get -yqq install openssh-client
    - mkdir ~/.ssh
    - ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
  script:
    - cp $SSH_KEY_CONTRACTS_JS ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - cd ./Goerli/clonefactory/ && make release-js
