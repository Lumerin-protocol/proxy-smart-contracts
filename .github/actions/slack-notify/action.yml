name: 'Slack Deployment Notification'
description: 'Send beautifully formatted deployment notifications to Slack'

inputs:
  status:
    description: 'Deployment status (success, failure, cancelled)'
    required: true
  environment:
    description: 'Target environment (dev, stg, main)'
    required: true
  service_name:
    description: 'Name of the service being deployed'
    required: true
  version:
    description: 'Version tag being deployed'
    required: true
  slack_webhook_url:
    description: 'Slack webhook URL'
    required: true
  github_token:
    description: 'GitHub token for API calls to fetch PR info'
    required: false
    default: ''
  additional_info:
    description: 'Additional info to include in markdown format (optional)'
    required: false
    default: ''
  image_tag:
    description: 'Docker image tag if applicable (optional)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Get PR info
      id: pr_info
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        # Try to find PR number from merge commit message first
        COMMIT_MSG=$(git log -1 --pretty=%s 2>/dev/null || echo "")
        
        # Pattern: "Merge pull request #123 from ..."
        if [[ "$COMMIT_MSG" =~ Merge\ pull\ request\ \#([0-9]+) ]]; then
          PR_NUMBER="${BASH_REMATCH[1]}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "üìé Found PR #$PR_NUMBER from merge commit"
        # Pattern: "... (#123)" - squash merge pattern
        elif [[ "$COMMIT_MSG" =~ \(\#([0-9]+)\) ]]; then
          PR_NUMBER="${BASH_REMATCH[1]}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "üìé Found PR #$PR_NUMBER from squash commit"
        # Fallback: Use GitHub API to find associated PR
        elif [ -n "$GH_TOKEN" ]; then
          PR_NUMBER=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls" \
            | jq -r '.[0].number // empty' 2>/dev/null || echo "")
          if [ -n "$PR_NUMBER" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "üìé Found PR #$PR_NUMBER from GitHub API"
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "üìé No PR found for this commit"
          fi
        else
          echo "pr_number=" >> $GITHUB_OUTPUT
          echo "üìé No PR info available (no token provided)"
        fi

    - name: Send Slack notification
      shell: bash
      env:
        SLACK_WEBHOOK: ${{ inputs.slack_webhook_url }}
        STATUS: ${{ inputs.status }}
        ENVIRONMENT: ${{ inputs.environment }}
        SERVICE_NAME: ${{ inputs.service_name }}
        VERSION: ${{ inputs.version }}
        ADDITIONAL_INFO: ${{ inputs.additional_info }}
        IMAGE_TAG: ${{ inputs.image_tag }}
        PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_SERVER_URL: ${{ github.server_url }}
      run: |
        # Set environment emoji and label
        case "$ENVIRONMENT" in
          dev)
            ENV_EMOJI="üîß"
            ENV_LABEL="DEV"
            ENV_COLOR="#3498db"
            ;;
          stg)
            ENV_EMOJI="üß™"
            ENV_LABEL="STG"
            ENV_COLOR="#9b59b6"
            ;;
          main)
            ENV_EMOJI="üöÄ"
            ENV_LABEL="PROD"
            ENV_COLOR="#2ecc71"
            ;;
          *)
            ENV_EMOJI="üì¶"
            ENV_LABEL="${ENVIRONMENT^^}"
            ENV_COLOR="#95a5a6"
            ;;
        esac
        
        # Set status emoji and color
        case "$STATUS" in
          success)
            STATUS_EMOJI="‚úÖ"
            COLOR="good"
            STATUS_TEXT="Deployed Successfully"
            ;;
          failure)
            STATUS_EMOJI="‚ùå"
            COLOR="danger"
            STATUS_TEXT="Deployment Failed"
            ;;
          cancelled)
            STATUS_EMOJI="‚ö†Ô∏è"
            COLOR="warning"
            STATUS_TEXT="Deployment Cancelled"
            ;;
          skipped)
            STATUS_EMOJI="‚è≠Ô∏è"
            COLOR="#808080"
            STATUS_TEXT="Deployment Skipped"
            ;;
          *)
            STATUS_EMOJI="‚ÑπÔ∏è"
            COLOR="#808080"
            STATUS_TEXT="$STATUS"
            ;;
        esac
        
        # Get commit info
        COMMIT_SHORT="${GITHUB_SHA:0:7}"
        
        # Get commit message (handle multiline by taking first line only)
        COMMIT_MSG=$(git log -1 --pretty=%s 2>/dev/null | head -n 1 | cut -c1-100 || echo "No commit message")
        # Clean up merge commit messages for display
        if [[ "$COMMIT_MSG" =~ ^Merge\ pull\ request\ \#[0-9]+\ from\ .*/(.+)$ ]]; then
          # Extract branch name from merge commit
          BRANCH_NAME="${BASH_REMATCH[1]}"
          COMMIT_MSG="Merged: ${BRANCH_NAME}"
        fi
        # Escape special characters for JSON
        COMMIT_MSG=$(echo "$COMMIT_MSG" | sed 's/\\/\\\\/g; s/"/\\"/g; s/`/\\`/g')
        
        # Extract repo name (short form)
        REPO_SHORT="${GITHUB_REPOSITORY#*/}"
        
        # Build workflow URL
        RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
        COMMIT_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
        
        # Build PR URL if we have a PR number
        PR_URL=""
        PR_BLOCK=""
        if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "" ]; then
          PR_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/pull/${PR_NUMBER}"
          PR_BLOCK=",{\"type\": \"mrkdwn\", \"text\": \"*Pull Request:*\\n<${PR_URL}|#${PR_NUMBER}>\"}"
        fi
        
        # Build additional info block if provided
        ADDITIONAL_BLOCK=""
        if [ -n "$ADDITIONAL_INFO" ] && [ "$ADDITIONAL_INFO" != "" ]; then
          # Escape the additional info for JSON
          ESCAPED_INFO=$(echo "$ADDITIONAL_INFO" | sed 's/\\/\\\\/g; s/"/\\"/g')
          ADDITIONAL_BLOCK=",{\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"${ESCAPED_INFO}\"}}"
        fi
        
        # Build image tag block if provided
        IMAGE_BLOCK=""
        if [ -n "$IMAGE_TAG" ] && [ "$IMAGE_TAG" != "" ]; then
          IMAGE_BLOCK=",{\"type\": \"mrkdwn\", \"text\": \"*Image:*\\n\\\`${IMAGE_TAG}\\\`\"}"
        fi
        
        # Build action buttons - always include workflow, add PR button if available
        if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "" ]; then
          ACTION_BUTTONS="[
            {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"üîÄ View PR #${PR_NUMBER}\", \"emoji\": true}, \"url\": \"${PR_URL}\", \"style\": \"primary\"},
            {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"üìã Workflow\", \"emoji\": true}, \"url\": \"${RUN_URL}\"},
            {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"üîç Commit\", \"emoji\": true}, \"url\": \"${COMMIT_URL}\"}
          ]"
        else
          ACTION_BUTTONS="[
            {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"üìã View Workflow\", \"emoji\": true}, \"url\": \"${RUN_URL}\", \"style\": \"primary\"},
            {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"üîç View Commit\", \"emoji\": true}, \"url\": \"${COMMIT_URL}\"}
          ]"
        fi
        
        # Send Slack message
        curl -s -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"$ENV_EMOJI $ENV_LABEL ‚îÇ $SERVICE_NAME ‚îÇ $STATUS_EMOJI $STATUS_TEXT\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Repository:*\\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}|${REPO_SHORT}>\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\\\`${GITHUB_REF_NAME}\\\`\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Version:*\\n\\\`${VERSION}\\\`\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Triggered by:*\\n${GITHUB_ACTOR}\"}${PR_BLOCK}${IMAGE_BLOCK}
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:* <${COMMIT_URL}|\\\`${COMMIT_SHORT}\\\`> ${COMMIT_MSG}\"
                  }
                }${ADDITIONAL_BLOCK},
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"actions\",
                  \"elements\": ${ACTION_BUTTONS}
                }
              ]
            }]
          }" \
          "$SLACK_WEBHOOK"
        
        echo "üì¢ Slack notification sent successfully"

